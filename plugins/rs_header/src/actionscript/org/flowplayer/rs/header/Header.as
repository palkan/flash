/** * */package org.flowplayer.rs.header {import com.longtailvideo.jwplayer.events.ViewEvent;import com.longtailvideo.jwplayer.utils.Animations;import com.longtailvideo.jwplayer.utils.Draw;import com.longtailvideo.jwplayer.utils.Logger;import com.longtailvideo.jwplayer.view.components.RSButton;import com.longtailvideo.jwplayer.view.components.RSButtonIcon;import com.longtailvideo.jwplayer.view.components.RelatedVideos;import flash.display.MovieClip;import flash.display.Sprite;import flash.events.Event;import flash.events.MouseEvent;import flash.events.TextEvent;import flash.net.URLLoader;import flash.net.URLRequest;import flash.net.navigateToURL;import flash.system.Capabilities;import flash.system.System;import flash.text.TextField;import flash.text.TextFieldAutoSize;import flash.text.TextFormat;import flash.utils.clearTimeout;import flash.utils.setTimeout;import org.flowplayer.model.Clip;import org.flowplayer.model.ClipEvent;import org.flowplayer.model.ClipEventType;import org.flowplayer.model.DisplayPluginModel;import org.flowplayer.model.Plugin;import org.flowplayer.model.PluginModel;import org.flowplayer.ui.AutoHide;import org.flowplayer.ui.AutoHideConfig;import org.flowplayer.view.AbstractSprite;import org.flowplayer.view.Flowplayer;import org.flowplayer.view.Styleable;/** * RussiaSport header plugin. * * @author palkan */public class Header extends AbstractSprite implements Plugin,Styleable {    private var _player:Flowplayer;    private var _model:DisplayPluginModel;    private var _container:MovieClip;    private var _back:Sprite;    private var _animations:Animations;    private var _fadingOut:uint;    private var _inited:Boolean = false;    private var _currentClip:Clip;    private var _lastW:int;    private var _lastH:int;    private var _created:Boolean = false;    //----- author and title ------//    private var title_txt:TextField;    private var author_txt:TextField;    //--- Related videos ------//    [Embed(source="../../../../../../../../ruskin/header/more.png")]    public var relButIcon:Class;    [Embed(source="../../../../../../../../ruskin/header/share.png")]    public var ShareIcon:Class;    [Embed(source="../../../../../../../../ruskin/header/copy.png")]    public var CopyIcon:Class;    private var rel_btn:MovieClip;    private var related_arr:Array;    private var related:RelatedVideos;    private var _waitForRealFinish:uint;    private const _waitTimeout:int = 2000;    //----  Share ---------//    private var share_btn:MovieClip;    private var share_field:MovieClip;    public function Header() {    }    override protected function onResize():void {        resize(width, height);    }    private function addHeader():Boolean {        _container = new MovieClip();        _back = Draw.gradientRect(_container, [0x000000, 0x000000], [1, 0], [0, 255], width, 100, 0, 0);        var _tf:TextFormat = new TextFormat();        _tf.align = "left";        _tf.color = "0xfa0000";        _tf.font = "Arial";        _tf.size = 11;        _tf.underline = true;        var _tf2:TextFormat = new TextFormat();        _tf2.align = "left";        _tf2.color = "0xffffff";        _tf2.font = "Arial";        _tf2.size = 18;        _tf2.underline = true;        title_txt = new TextField();        title_txt.selectable = false;        title_txt.defaultTextFormat = _tf2;        title_txt.width = 450;        title_txt.wordWrap = true;        title_txt.multiline = true;        title_txt.htmlText = '<a href="event:title">' + _model.config['title'] + '</a>';        title_txt.y = 47;        title_txt.x = 18;        title_txt.name = "title";        title_txt.addEventListener(TextEvent.LINK, onClick);        _container.addChild(title_txt);        author_txt = new TextField();        author_txt.selectable = false;        author_txt.defaultTextFormat = _tf;        author_txt.autoSize = TextFieldAutoSize.LEFT;        author_txt.htmlText = '<a href="event:author">' + _model.config['author'] + '</a>';        author_txt.y = 27;        author_txt.x = 18;        author_txt.height = 20;        author_txt.name = "author";        author_txt.addEventListener(TextEvent.LINK, onClick);        _container.addChild(author_txt);        // _player.addEventListener( ,onStateChanged);        _player.playlist.onBeforeBegin(function (e:ClipEvent) {            _currentClip = _player.currentClip;            _waitForRealFinish && clearTimeout(_waitForRealFinish);            _currentClip.onAll(onStateChanged)        });        addChild(_container);        if (_model.config['related']) loadRelated(_model.config['related']);        if(_model.config['share']){            if(Capabilities.screenResolutionY>2000)                share_btn = new RSButtonIcon(new ShareIcon());            else                share_btn = new RSButton("Поделиться");            share_btn.y = 7;            share_btn.addEventListener(MouseEvent.CLICK,onShareClick);            _container.addChild(share_btn);            share_field = new MovieClip();            share_field.visible = false;            share_field.x = 5;            share_field.y = 35;            var link_txt:TextField = new TextField();            link_txt.x = 13;            link_txt.y = 13;            link_txt.selectable = true;            link_txt.autoSize = TextFieldAutoSize.LEFT;            var tf:TextFormat = new TextFormat();            tf.color =0x999999;            tf.font = "Arial";            tf.kerning = true;            tf.size = 12;            link_txt.defaultTextFormat = tf;            link_txt.text = _model.config['share'];            share_field.addChild(link_txt);            var share_copy:MovieClip = new MovieClip();            share_copy.addChild(new CopyIcon());            share_copy.x = 525;            share_copy.y = 15;            share_copy.name = "share";            share_copy.addEventListener(MouseEvent.CLICK,onShareFieldClick);            share_field.addChild(share_copy);            if(_model.config['embed']){            var embed_txt:TextField = new TextField();            embed_txt.x = 13;            embed_txt.y = 46;            embed_txt.width = 506;            embed_txt.wordWrap = true;            embed_txt.multiline = true;            embed_txt.selectable = true;            embed_txt.autoSize = TextFieldAutoSize.LEFT;            embed_txt.defaultTextFormat = tf;            embed_txt.text = _model.config['embed'];            share_field.addChild(embed_txt);            var embed_copy:MovieClip = new MovieClip();            embed_copy.addChild(new CopyIcon());            embed_copy.x = 525;            embed_copy.y = 65;            embed_copy.name = "embed";            embed_copy.addEventListener(MouseEvent.CLICK,onShareFieldClick);            share_field.addChild(embed_copy);            }            share_field.graphics.lineStyle(1,0x333333);            share_field.graphics.beginFill(0x000000);            share_field.graphics.drawRoundRect(0,0,548,127,3,3);            share_field.graphics.endFill();            share_field.graphics.lineStyle(1,0x333333);            share_field.graphics.drawRoundRect(12,12,508,22,6,6);            if(_model.config['embed']){                share_field.graphics.lineStyle(1,0x333333);                share_field.graphics.drawRoundRect(12,45,508,72,6,6);            }            share_field.addEventListener(MouseEvent.CLICK,onShareFieldClick);            _container.addChild(share_field);            share_btn.x = _back.width - 10 - share_btn.width;            if(rel_btn)                share_btn.x = _back.width - 10 - rel_btn.width - 10 - share_btn.width;        }        _animations = new Animations(_container);        return (_created = true);    }    protected function onShareClick(event:MouseEvent):void    {        if(share_field.visible){            share_field.visible = false;            _back.height = 100;            author_txt.visible = true;            title_txt.visible = true;            if(!_player.isPlaying()) _player.showPlugin('play');        }else{            _back.height = _lastH;            author_txt.visible = false;            title_txt.visible = false;            share_field.visible = true;            if(related)                related.visible = false;            if(!_player.isPlaying()) _player.hidePlugin('play');        }        event.stopPropagation();    }    protected function onShareFieldClick(event:MouseEvent):void    {        Logger.log(event.target.name,"name");        if(event.target.name === "share")            System.setClipboard(_model.config['share']);        if(event.target.name === "embed")            System.setClipboard(_model.config['embed']);        event.stopPropagation();    }    protected function onMouseClick(event:MouseEvent):void {        event.stopPropagation();        event.target.removeEventListener(MouseEvent.CLICK, onMouseClick);    }    protected function onClick(event:TextEvent):void {        event.target.addEventListener(MouseEvent.CLICK, onMouseClick);        if (_model.config[event.target.name + '_link'])            navigateToURL(new URLRequest(_model.config[event.target.name + '_link']));    }    private function loadRelated(src:String):void {        Logger.log(src, "RELSOURCE");        var loader:URLLoader = new URLLoader();        loader.addEventListener(Event.COMPLETE, onComplete);        loader.load(new URLRequest(src));    }    protected function onComplete(event:Event):void {        var loader:URLLoader = event.target as URLLoader;        Logger.log(loader.data, "Loader");        if (loader.data) {            var _xml:XML = new XML(loader.data);            related_arr = [];            for each(var item:XML in _xml.item) {                related_arr.push({url: item..url, image: item..image, duration: item..duration, title: item..title});            }            if (related_arr.length > 0)                initRelated();        }    }    private function initRelated():void {        if (Capabilities.screenResolutionY > 2000)            rel_btn = new RSButtonIcon(new relButIcon());        else            rel_btn = new RSButton("Еще видео");        rel_btn.y = 7;        rel_btn.addEventListener(MouseEvent.CLICK, onRelClick);        _container.addChild(rel_btn);        rel_btn.x = _back.width - 10 - rel_btn.width;        related = new RelatedVideos();        related.init(related_arr);        related.x = 20;        related.y = 32;        related.visible = false;        _container.addChild(related);        related.addEventListener(ViewEvent.JWPLAYER_VIEW_CLICK, onRelatedClick);         if(share_btn)            share_btn.x = _back.width - 10 - rel_btn.width - 10 - share_btn.width;    }    private function onRelClick(event:MouseEvent = null):void {        if (related.visible) {            _back.height = 100;            related.visible = false;            author_txt.visible = true;            title_txt.visible = true;            if(!_player.isPlaying()) _player.showPlugin('play');        } else {            _back.height = _lastH-40;            author_txt.visible = false;            title_txt.visible = false;            if(share_field)                share_field.visible = false;            related.visible = true;            if(!_player.isPlaying()) _player.hidePlugin('play');        }        event && event.stopPropagation();        //	startFader();    }    protected function onRelatedClick(event:ViewEvent):void {        Logger.log(event.data, "related");        if (event.data != "")            navigateToURL(new URLRequest(event.data));        //startFader();    }    private function onStateChanged(event:ClipEvent):void {        if (event.eventType === ClipEventType.PAUSE){            stage.removeEventListener(MouseEvent.MOUSE_MOVE, onMouseMove);            if (!isNaN(_fadingOut)) {                clearTimeout(_fadingOut);            }            _animations.ease(_container.x, 0, 2);        }else if(event.eventType === ClipEventType.FINISH){           _waitForRealFinish = setTimeout(realFinish,_waitTimeout);        } else if (event.eventType === ClipEventType.RESUME || event.eventType === ClipEventType.BEGIN) {            _waitForRealFinish && clearTimeout(_waitForRealFinish);            //related && related.visible && onRelClick();            startFader();            stage.addEventListener(MouseEvent.MOUSE_MOVE, onMouseMove);        }    }    private function realFinish(){        stage.removeEventListener(MouseEvent.MOUSE_MOVE, onMouseMove);        if (!isNaN(_fadingOut)) {            clearTimeout(_fadingOut);        }        _animations.ease(_container.x, 0, 2);        related && (!related.visible) && onRelClick();    }    private function onMouseMove(event:MouseEvent):void {        if (_container.y != 0)            _animations.ease(_container.x, 0, 2);        startFader();    }    private function startFader():void {        if (!isNaN(_fadingOut)) {            clearTimeout(_fadingOut);        }        _fadingOut = setTimeout(moveTimeout, 2000);    }    private function moveTimeout(evt:Event = null):void {        _animations.ease(x, -_container.height, 2);    }    public function resize(w:Number, h:Number):void {        if (!w || !h) return;        !_created && addHeader();        var _scale:Number = w / _back.width;        _lastW = w;        _lastH = h;        _container.scaleX = _scale;        _container.scaleY = _scale;        if(share_btn){            share_btn.x = _back.width - 10 - share_btn.width;            rel_btn && (share_btn.x -= rel_btn.width + 10);        }        rel_btn && (rel_btn.x = _back.width - 10 - rel_btn.width);    }    /**     * Sets the plugin model. This gets called before the plugin     * has been added to the display list and before the player is set.     * @param plugin     */    public function onConfig(plugin:PluginModel):void {        _model = plugin as DisplayPluginModel;        if (plugin.config && plugin.config.author && plugin.config.title) {            log.debug("config object received with author " + plugin.config.author + ", title " + plugin.config.title);            _inited = true;        } else {            log.debug("wrong parameters");        }    }    /**     * Sets the Flowplayer interface. The interface is immediately ready to use, all     * other plugins have been loaded an initialized also.     * @param player     */    public function onLoad(player:Flowplayer):void {        log.info("set player");        _player = player;        _inited && _model.dispatchOnLoad();    }    public function getDefaultConfig():Object {        return {};    }    /**     * Notifies new css properties.     *     * @param styleProps and object containing the new properties. The propertis contained by this     * object are added, if a specific object already exists it's overwritten. If the parameter is not specified     * returns the current style properties.     * @return void     */    public function onBeforeCss(styleProps:Object = null):void {        log.debug('style before', styleProps);    };    /**     * Sets/adds css style properties.     *     * @param styleProps and object containing the new properties. The propertis contained by this     * object are added, if a specific object already exists it's overwritten. If the parameter is not specified     * returns the current style properties.     * @return the style props after setting the new properties     */    public function css(styleProps:Object = null):Object {        log.debug('style css', styleProps);        return {}    };    /**     * Notifies a css properties animation.     *     * @param styleProps and object containing the properties to be animated. The propertis contained by this     * object are added, if a specific object already exists it's overwritten.     * @return void     */    public function onBeforeAnimate(styleProps:Object):void {        log.debug('style before animate', styleProps);    };    /**     * Animates css properties.     *     * @param styleProps and object containing the properties to be animated. The propertis contained by this     * object are added, if a specific object already exists it's overwritten.     * @return the style props after setting the new properties     */    public function animate(styleProps:Object):Object {        log.debug('style animate', styleProps);        return {}    };}}